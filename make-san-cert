#!/usr/bin/env python3

import os
import sys
import re
import textwrap

def undent(s):
  return re.sub('\n +','\n',s.lstrip())

def config(subject, sans):
    names = list(enumerate(sans, 1))
    dns = [f"DNS.{i} = {n}" for i,n in names if re.match("^\D", n)]
    ips = [f"IP.{i} = {n}" for i,n in names if re.match("^\d", n)]
    names = "\n".join(dns + ips)
    text = undent(f"""
        [req]
        distinguished_name = dn
        req_extensions = v3_req
        default_bits = 2048
        prompt = no
        default_md = sha256
        [dn]
        C = UK
        ST = England
        L = London
        O = example.com
        emailAddress = hostmaster@example.com
        CN = {subject}
        [v3_req]
        keyUsage = keyEncipherment, dataEncipherment
        extendedKeyUsage = serverAuth
        subjectAltName = @alt_names
        [alt_names]
        {names}
        """)
    with open(f"{subject}.cnf", 'w') as f:
      f.write(text)

def cmd(s):
    os.system(undent(s))

def key(subject):
    os.system(f"openssl genrsa -out {subject}.key 4096")

def csr(subject, sans):
    config(subject, sans)
    os.system(f"openssl req -new -nodes -sha256 -key {subject}.key -config {subject}.cnf -out {subject}.csr")

def sign(subject):
    os.system(f"openssl x509 -req -in {subject}.csr -extfile {subject}.cnf -extensions v3_req -out {subject}.crt -CA cacert.pem -CAkey private/cakey.key -CAcreateserial -days 3650 -sha256")

subject = sys.argv[1]
names = sys.argv[2:]
key(subject)
csr(subject, names)
sign(subject)
